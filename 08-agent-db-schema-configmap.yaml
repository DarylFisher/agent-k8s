apiVersion: v1
kind: ConfigMap
metadata:
  name: agent-db-schema
  namespace: agent-scheduler
  labels:
    app: agent-db-api
data:
  agent-schema.sql: |
    -- Agent-DB-API Database Schema
    -- Tables for agent configuration, logging, and simulation data
    -- Compatible with PostgreSQL 12+

    -- ============================================================================
    -- Warehouse Table: Stores warehouse configurations
    -- ============================================================================
    CREATE TABLE IF NOT EXISTS warehouse (
        warehouse VARCHAR(50) PRIMARY KEY,
        description VARCHAR(100),
        csnx_company VARCHAR(5),
        csnx_facl VARCHAR(1),
        csnx_whse VARCHAR(2),
        inquiry_url VARCHAR(200),
        update_url VARCHAR(200)
    );

    -- ============================================================================
    -- Agent Table: Stores agent type definitions
    -- ============================================================================
    CREATE TABLE IF NOT EXISTS agent (
        agent VARCHAR(50) PRIMARY KEY,
        description VARCHAR(200),
        agent_parameters JSONB
    );

    -- ============================================================================
    -- Agent Assignment Table: Links agents to warehouses with configuration
    -- ============================================================================
    CREATE TABLE IF NOT EXISTS agent_assignment (
        agent VARCHAR(50) NOT NULL,
        warehouse VARCHAR(50) NOT NULL,
        status VARCHAR(20) NOT NULL DEFAULT 'stopped',
        model_parameters JSONB,
        agent_whse_parameters JSONB,
        last_updated TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        PRIMARY KEY (agent, warehouse),
        FOREIGN KEY (agent) REFERENCES agent(agent),
        FOREIGN KEY (warehouse) REFERENCES warehouse(warehouse)
    );

    -- Create function and trigger to update last_updated timestamp
    CREATE OR REPLACE FUNCTION update_agent_assignment_timestamp()
    RETURNS TRIGGER AS $$
    BEGIN
        NEW.last_updated = CURRENT_TIMESTAMP;
        RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;

    DROP TRIGGER IF EXISTS update_agent_assignment_last_updated ON agent_assignment;
    CREATE TRIGGER update_agent_assignment_last_updated
        BEFORE UPDATE ON agent_assignment
        FOR EACH ROW
        EXECUTE FUNCTION update_agent_assignment_timestamp();

    -- ============================================================================
    -- Model Audit Table: Tracks model parameter changes
    -- ============================================================================
    CREATE TABLE IF NOT EXISTS model_audit (
        audit_id SERIAL PRIMARY KEY,
        agent VARCHAR(50) NOT NULL,
        warehouse VARCHAR(50) NOT NULL,
        old_model_parameters JSONB,
        change_timestamp TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        changed_by VARCHAR(50),
        FOREIGN KEY (agent) REFERENCES agent(agent),
        FOREIGN KEY (warehouse) REFERENCES warehouse(warehouse)
    );

    CREATE INDEX IF NOT EXISTS idx_model_audit_agent ON model_audit(agent);
    CREATE INDEX IF NOT EXISTS idx_model_audit_warehouse ON model_audit(warehouse);
    CREATE INDEX IF NOT EXISTS idx_model_audit_timestamp ON model_audit(change_timestamp DESC);

    -- ============================================================================
    -- Agent Log Table: Application logs from agents
    -- ============================================================================
    CREATE TABLE IF NOT EXISTS agent_log (
        log_id SERIAL PRIMARY KEY,
        timestamp TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        agent VARCHAR(50) NOT NULL,
        warehouse VARCHAR(50) NOT NULL,
        log_level VARCHAR(10) NOT NULL,
        message TEXT NOT NULL,
        logger_name VARCHAR(100),
        module VARCHAR(100),
        func_name VARCHAR(100),
        line_no INTEGER,
        FOREIGN KEY (agent) REFERENCES agent(agent),
        FOREIGN KEY (warehouse) REFERENCES warehouse(warehouse)
    );

    CREATE INDEX IF NOT EXISTS idx_agent_log_timestamp ON agent_log(timestamp);
    CREATE INDEX IF NOT EXISTS idx_agent_log_agent ON agent_log(agent);
    CREATE INDEX IF NOT EXISTS idx_agent_log_warehouse ON agent_log(warehouse);
    CREATE INDEX IF NOT EXISTS idx_agent_log_level ON agent_log(log_level);

    -- ============================================================================
    -- Agent Schedule Table: Scheduling configurations
    -- ============================================================================
    CREATE TABLE IF NOT EXISTS agent_schedule (
        schedule_id SERIAL PRIMARY KEY,
        agent VARCHAR(50) NOT NULL,
        warehouse VARCHAR(50) NOT NULL,
        description VARCHAR(255),
        schedule_type VARCHAR(20) NOT NULL DEFAULT 'execution',
        run_time VARCHAR(5),
        from_time VARCHAR(5),
        end_time VARCHAR(5),
        execution_interval INTEGER,
        daily_cycle INTEGER NOT NULL DEFAULT 127,
        timezone VARCHAR(50) NOT NULL DEFAULT 'UTC',
        is_enabled BOOLEAN NOT NULL DEFAULT TRUE,
        last_triggered_at TIMESTAMP WITH TIME ZONE,
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (agent, warehouse) REFERENCES agent_assignment(agent, warehouse) ON DELETE CASCADE
    );

    CREATE INDEX IF NOT EXISTS idx_agent_schedule_agent ON agent_schedule(agent);
    CREATE INDEX IF NOT EXISTS idx_agent_schedule_warehouse ON agent_schedule(warehouse);
    CREATE INDEX IF NOT EXISTS idx_agent_schedule_enabled ON agent_schedule(is_enabled);

    -- ============================================================================
    -- Simulation Header Table: Simulation run metadata
    -- ============================================================================
    CREATE TABLE IF NOT EXISTS simulation_header (
        simulation_run_id SERIAL PRIMARY KEY,
        agent VARCHAR(255) NOT NULL,
        warehouse VARCHAR(255) NOT NULL,
        run_timestamp TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL
    );

    CREATE INDEX IF NOT EXISTS idx_simulation_header_agent ON simulation_header(agent);
    CREATE INDEX IF NOT EXISTS idx_simulation_header_warehouse ON simulation_header(warehouse);
    CREATE INDEX IF NOT EXISTS idx_simulation_header_timestamp ON simulation_header(run_timestamp DESC);

    -- ============================================================================
    -- Simulation Detail Table: Detailed simulation results
    -- ============================================================================
    CREATE TABLE IF NOT EXISTS simulation_detail (
        simulation_detail_id SERIAL PRIMARY KEY,
        simulation_run_id INTEGER NOT NULL,
        whse_sect VARCHAR(50) NOT NULL,
        task_information JSONB,
        gantt_chart_image BYTEA,
        FOREIGN KEY (simulation_run_id) REFERENCES simulation_header(simulation_run_id) ON DELETE CASCADE
    );

    CREATE INDEX IF NOT EXISTS idx_simulation_detail_run_id ON simulation_detail(simulation_run_id);
    CREATE INDEX IF NOT EXISTS idx_simulation_detail_whse_sect ON simulation_detail(whse_sect);

    -- ============================================================================
    -- Sample Data: Example warehouse and agent for testing
    -- ============================================================================

    -- Insert sample warehouse (Kilcock)
    INSERT INTO warehouse (warehouse, description, csnx_company, csnx_facl, csnx_whse, inquiry_url, update_url)
    VALUES ('Kilcock', 'Kilcock Warehouse', '10000', '1', '01',
            'http://example.com/inquiry', 'http://example.com/update')
    ON CONFLICT (warehouse) DO NOTHING;

    -- Insert sample agent (Pick Release)
    INSERT INTO agent (agent, description, agent_parameters)
    VALUES ('Pick Release', 'Pick Release Agent', '{"default_param": "value"}'::jsonb)
    ON CONFLICT (agent) DO NOTHING;

    -- Insert agent assignment
    INSERT INTO agent_assignment (agent, warehouse, status, model_parameters)
    VALUES ('Pick Release', 'Kilcock', 'stopped', '{}'::jsonb)
    ON CONFLICT (agent, warehouse) DO NOTHING;

    -- Log completion
    DO $$
    BEGIN
        RAISE NOTICE 'Agent-DB-API schema loaded successfully - 8 tables created';
    END $$;
