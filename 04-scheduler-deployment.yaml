---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: scheduler-sa
  namespace: agent-scheduler
  labels:
    app: scheduler

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: scheduler-job-manager
  namespace: agent-scheduler
  labels:
    app: scheduler
rules:
  # Permissions for managing Jobs
  - apiGroups: ["batch"]
    resources: ["jobs"]
    verbs: ["create", "get", "list", "watch", "delete", "deletecollection"]
  # Permissions for monitoring Pods
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch"]
  # Permissions for getting Pod logs
  - apiGroups: [""]
    resources: ["pods/log"]
    verbs: ["get"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: scheduler-job-manager-binding
  namespace: agent-scheduler
  labels:
    app: scheduler
subjects:
  - kind: ServiceAccount
    name: scheduler-sa
    namespace: agent-scheduler
roleRef:
  kind: Role
  name: scheduler-job-manager
  apiGroup: rbac.authorization.k8s.io

---
apiVersion: v1
kind: Service
metadata:
  name: scheduler-service
  namespace: agent-scheduler
  labels:
    app: scheduler
spec:
  type: ClusterIP
  ports:
    - port: 8000
      targetPort: 8000
      protocol: TCP
      name: api
    - port: 9090
      targetPort: 9090
      protocol: TCP
      name: metrics
  selector:
    app: scheduler

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: scheduler
  namespace: agent-scheduler
  labels:
    app: scheduler
spec:
  replicas: 1
  selector:
    matchLabels:
      app: scheduler
  template:
    metadata:
      labels:
        app: scheduler
    spec:
      serviceAccountName: scheduler-sa
      containers:
        - name: scheduler
          image: docker.io/library/scheduler:latest
          imagePullPolicy: IfNotPresent  # Use local image from Docker Desktop
          ports:
            - containerPort: 8000
              name: api
            - containerPort: 9090
              name: metrics
          env:
            # Application Configuration
            - name: ENVIRONMENT
              valueFrom:
                configMapKeyRef:
                  name: scheduler-config
                  key: ENVIRONMENT
            - name: APPLICATION_NAME
              valueFrom:
                configMapKeyRef:
                  name: scheduler-config
                  key: APPLICATION_NAME

            # API Configuration
            - name: API_HOST
              valueFrom:
                configMapKeyRef:
                  name: scheduler-config
                  key: API_HOST
            - name: API_PORT
              valueFrom:
                configMapKeyRef:
                  name: scheduler-config
                  key: API_PORT
            - name: API_PREFIX
              valueFrom:
                configMapKeyRef:
                  name: scheduler-config
                  key: API_PREFIX
            - name: METRICS_PORT
              valueFrom:
                configMapKeyRef:
                  name: scheduler-config
                  key: METRICS_PORT

            # Database Configuration
            - name: DATABASE_HOST
              valueFrom:
                configMapKeyRef:
                  name: scheduler-config
                  key: DATABASE_HOST
            - name: DATABASE_PORT
              valueFrom:
                configMapKeyRef:
                  name: scheduler-config
                  key: DATABASE_PORT
            - name: DATABASE_NAME
              valueFrom:
                configMapKeyRef:
                  name: scheduler-config
                  key: DATABASE_NAME
            - name: DATABASE_USER
              valueFrom:
                secretKeyRef:
                  name: scheduler-secrets
                  key: DATABASE_USER
            - name: DATABASE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: scheduler-secrets
                  key: DATABASE_PASSWORD

            # Scheduler Configuration
            - name: SCHEDULER_TIMEZONE
              valueFrom:
                configMapKeyRef:
                  name: scheduler-config
                  key: SCHEDULER_TIMEZONE
            - name: MAX_CONCURRENT_JOBS
              valueFrom:
                configMapKeyRef:
                  name: scheduler-config
                  key: MAX_CONCURRENT_JOBS

            # Kubernetes Configuration
            - name: KUBERNETES_NAMESPACE
              valueFrom:
                configMapKeyRef:
                  name: scheduler-config
                  key: KUBERNETES_NAMESPACE
            - name: KUBERNETES_JOB_TTL
              valueFrom:
                configMapKeyRef:
                  name: scheduler-config
                  key: KUBERNETES_JOB_TTL
            - name: KUBERNETES_IN_CLUSTER
              valueFrom:
                configMapKeyRef:
                  name: scheduler-config
                  key: KUBERNETES_IN_CLUSTER

            # Agent Configuration
            - name: DEFAULT_AGENT_IMAGE
              valueFrom:
                configMapKeyRef:
                  name: scheduler-config
                  key: DEFAULT_AGENT_IMAGE
            - name: DEFAULT_CONTAINER_MEMORY
              valueFrom:
                configMapKeyRef:
                  name: scheduler-config
                  key: DEFAULT_CONTAINER_MEMORY
            - name: DEFAULT_CONTAINER_CPU
              valueFrom:
                configMapKeyRef:
                  name: scheduler-config
                  key: DEFAULT_CONTAINER_CPU

            # External Services
            - name: AGENT_DATA_STORE_URL
              valueFrom:
                configMapKeyRef:
                  name: scheduler-config
                  key: AGENT_DATA_STORE_URL
            - name: LOGGING_SERVICE_URL
              valueFrom:
                configMapKeyRef:
                  name: scheduler-config
                  key: LOGGING_SERVICE_URL

            # CORS Configuration
            - name: CORS_ALLOWED_ORIGINS
              valueFrom:
                configMapKeyRef:
                  name: scheduler-config
                  key: CORS_ALLOWED_ORIGINS
          resources:
            requests:
              memory: "256Mi"
              cpu: "200m"
            limits:
              memory: "1Gi"
              cpu: "1000m"
          livenessProbe:
            httpGet:
              path: /api/v1/health
              port: 8000
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /api/v1/health
              port: 8000
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 3
            failureThreshold: 3
